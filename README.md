# ZiyiDB: ä»é›¶å®ç°ä¸€ä¸ªç®€å•çš„ SQL æ•°æ®åº“

ZiyiDB æ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€å®ç°çš„ç®€å• SQL æ•°æ®åº“ï¼Œæ”¯æŒåŸºæœ¬çš„ SQL æ“ä½œã€‚æœ¬æ•™ç¨‹å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œä¸€æ­¥æ­¥å®ç°ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ SQL æ•°æ®åº“ã€‚

## åŠŸèƒ½ç‰¹æ€§

- æ”¯æŒåŸºæœ¬çš„ SQL è¯­å¥ï¼šCREATE TABLE, INSERT, SELECT, UPDATE, DELETE, DROP TABLE
- æ”¯æŒ WHERE å­å¥å’ŒåŸºæœ¬çš„æ¡ä»¶è¡¨è¾¾å¼
- æ”¯æŒ LIKE æ“ä½œç¬¦è¿›è¡Œæ¨¡å¼åŒ¹é…
- äº¤äº’å¼å‘½ä»¤è¡Œç•Œé¢ï¼Œæ”¯æŒå‘½ä»¤å†å²
- å†…å­˜å­˜å‚¨å¼•æ“

## é¡¹ç›®ç»“æ„

```
ziyi-db/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ main.go          # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ ast/            # æŠ½è±¡è¯­æ³•æ ‘å®šä¹‰
â”‚   â”œâ”€â”€ lexer/          # è¯æ³•åˆ†æå™¨
â”‚   â”œâ”€â”€ parser/         # è¯­æ³•åˆ†æå™¨
â”‚   â””â”€â”€ storage/        # å­˜å‚¨å¼•æ“
â”œâ”€â”€ go.mod
â””â”€â”€ README.md
```

## æ•™ç¨‹ç›®å½•

1. [è¯æ³•åˆ†æå™¨ (Lexer)](#1-è¯æ³•åˆ†æå™¨-lexer)
2. [æŠ½è±¡è¯­æ³•æ ‘ (AST)](#2-æŠ½è±¡è¯­æ³•æ ‘-ast)
3. [è¯­æ³•åˆ†æå™¨ (Parser)](#3-è¯­æ³•åˆ†æå™¨-parser)
4. [å­˜å‚¨å¼•æ“ (Storage)](#4-å­˜å‚¨å¼•æ“-storage)
5. [REPL äº¤äº’ç•Œé¢](#5-repl-äº¤äº’ç•Œé¢)

## 1. è¯æ³•åˆ†æå™¨ (Lexer)

è¯æ³•åˆ†æå™¨è´Ÿè´£å°†è¾“å…¥çš„ SQL è¯­å¥åˆ†è§£æˆä¸€ç³»åˆ—æ ‡è®°ï¼ˆTokenï¼‰ã€‚æ¯ä¸ªæ ‡è®°ä»£è¡¨ä¸€ä¸ªè¯­æ³•å•å…ƒï¼Œå¦‚å…³é”®å­—ã€æ ‡è¯†ç¬¦ã€è¿ç®—ç¬¦ç­‰ã€‚

### 1.1 å®šä¹‰æ ‡è®°ç±»å‹

æ–°å»ºziyi-db/internal/lexer/token.goæ–‡ä»¶,å®Œæˆè¯æ³•åˆ†æå™¨ï¼ˆLexerï¼‰ä¸­çš„æ ‡è®°ï¼ˆTokenï¼‰å®šä¹‰éƒ¨åˆ†ï¼Œç”¨äºå°† SQL è¯­å¥åˆ†è§£æˆåŸºæœ¬çš„è¯­æ³•å•å…ƒã€‚
å®šä¹‰è¯æ³•å•å…ƒä»¥åŠå…³é”®å­—
- åŒ…å«å¸¸è§çš„SQLå…³é”®å­—ï¼Œå¦‚ï¼šselectã€updateç­‰
- åŒ…å«ç¬¦å·å…³é”®å­—ï¼š=ã€>ã€<
- åŒ…å«å­—æ®µç±»å‹ï¼šINTã€å­—ç¬¦å‹
- åŒ…å«æ ‡è¯†ç¬¦ï¼šINDENTï¼Œè§£æå‡ºæ¥çš„SQLåˆ—åã€è¡¨å
```go
type TokenType string

const (
    SELECT  TokenType = "SELECT"
    FROM    TokenType = "FROM"
    IDENT   TokenType = "IDENT"  // æ ‡è¯†ç¬¦ï¼ˆå¦‚åˆ—åã€è¡¨åï¼‰
    INT_LIT TokenType = "INT"    // æ•´æ•°å­—é¢é‡
    STRING  TokenType = "STRING" // å­—ç¬¦ä¸²å­—é¢é‡
    EQ TokenType = "=" // ç­‰äº
    GT TokenType = ">" // å¤§äº
    LT TokenType = "<" // å°äº
    ....
)

// Token è¯æ³•å•å…ƒ
// Typeï¼šæ ‡è®°çš„ç±»å‹ï¼ˆå¦‚ SELECTã€IDENT ç­‰ï¼‰
// Literalï¼šæ ‡è®°çš„å®é™…å€¼ï¼ˆå¦‚å…·ä½“çš„åˆ—åã€æ•°å­—ç­‰ï¼‰
type Token struct {
    Type    TokenType // æ ‡è®°ç±»å‹
    Literal string    // æ ‡è®°çš„å®é™…å€¼
}
```

### 1.2 å®ç°è¯æ³•åˆ†æå™¨
æ–°å»ºziyi-db/internal/lexer/lexer.goæ–‡ä»¶ï¼Œè¿™æ˜¯è¯æ³•åˆ†æå™¨ï¼ˆLexerï¼‰çš„æ ¸å¿ƒå®ç°ï¼Œè´Ÿè´£å°†è¾“å…¥çš„ SQL è¯­å¥åˆ†è§£æˆæ ‡è®°ï¼ˆTokenï¼‰åºåˆ—ã€‚
è¯»å–SQLåˆ°å†…å­˜ä¸­å¹¶è¿›è¡Œè§£æï¼Œå°†å­—ç¬¦è½¬æ¢ä¸ºå¯¹åº”å…³é”®å­—


```go
/**

ç¤ºä¾‹ï¼šSELECT id, name FROM users WHERE age > 18;

å¤„ç†è¿‡ç¨‹ï¼š
è·³è¿‡ç©ºç™½å­—ç¬¦
è¯»å– "SELECT" å¹¶è¯†åˆ«ä¸ºå…³é”®å­—
è¯»å– "id" å¹¶è¯†åˆ«ä¸ºæ ‡è¯†ç¬¦
è¯»å– "," å¹¶è¯†åˆ«ä¸ºåˆ†éš”ç¬¦
è¯»å– "name" å¹¶è¯†åˆ«ä¸ºæ ‡è¯†ç¬¦
è¯»å– "FROM" å¹¶è¯†åˆ«ä¸ºå…³é”®å­—
è¯»å– "users" å¹¶è¯†åˆ«ä¸ºæ ‡è¯†ç¬¦
è¯»å– "WHERE" å¹¶è¯†åˆ«ä¸ºå…³é”®å­—
è¯»å– "age" å¹¶è¯†åˆ«ä¸ºæ ‡è¯†ç¬¦
è¯»å– ">" å¹¶è¯†åˆ«ä¸ºè¿ç®—ç¬¦
è¯»å– "18" å¹¶è¯†åˆ«ä¸ºæ•°å­—
è¯»å– ";" å¹¶è¯†åˆ«ä¸ºåˆ†éš”ç¬¦
è¿™ä¸ªè¯æ³•åˆ†æå™¨æ˜¯ SQL è§£æå™¨çš„ç¬¬ä¸€æ­¥ï¼Œå®ƒå°†è¾“å…¥çš„ SQL è¯­å¥åˆ†è§£æˆæ ‡è®°åºåˆ—ï¼Œä¸ºåç»­çš„è¯­æ³•åˆ†ææä¾›åŸºç¡€

è¯¥SQL è¯­å¥ä¼šè¢«è¯æ³•åˆ†æå™¨åˆ†è§£æˆä»¥ä¸‹æ ‡è®°åºåˆ—ï¼š
{Type: SELECT, Literal: "SELECT"}
{Type: IDENT, Literal: "id"}
{Type: COMMA, Literal: ","}
{Type: IDENT, Literal: "name"}
{Type: FROM, Literal: "FROM"}
{Type: IDENT, Literal: "users"}
{Type: WHERE, Literal: "WHERE"}
{Type: IDENT, Literal: "age"}
{Type: GT, Literal: ">"}
{Type: INT_LIT, Literal: "18"}
{Type: SEMI, Literal: ";"}
è§£æåçš„æ ‡è®°éšåä¼šè¢«ä¼ é€’ç»™è¯­æ³•åˆ†æå™¨ï¼ˆParserï¼‰è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œæ„å»ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚
 */
```

## 2. æŠ½è±¡è¯­æ³•æ ‘ (AST)
> æŠ½è±¡è¯­æ³•æ ‘ç”¨äºè¡¨ç¤º SQL è¯­å¥çš„è¯­æ³•ç»“æ„ã€‚æˆ‘ä»¬éœ€è¦ä¸ºæ¯ç§ SQL è¯­å¥å®šä¹‰ç›¸åº”çš„èŠ‚ç‚¹ç±»å‹ã€‚
> 
æ–°å»ºinternal/ast/ast.go
æ„å»ºä¸åŒSQLè¯­å¥çš„ç»“æ„ï¼Œä»¥åŠæŸ¥è¯¢ç»“æœç­‰ã€‚
è¿™ä¸ª AST å®šä¹‰æ–‡ä»¶æ˜¯ SQL è§£æå™¨çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒï¼š
1. å®šä¹‰äº†æ‰€æœ‰ SQL è¯­å¥çš„è¯­æ³•ç»“æ„
2. æä¾›äº†ç±»å‹å®‰å…¨çš„æ–¹å¼æ¥è¡¨ç¤º SQL è¯­å¥
3. æ”¯æŒå¤æ‚çš„è¡¨è¾¾å¼å’Œæ¡ä»¶
4. ä¾¿äºåç»­çš„è¯­ä¹‰åˆ†æå’Œæ‰§è¡Œ
   é€šè¿‡è¿™ä¸ª ASTï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
- éªŒè¯ SQL è¯­å¥çš„è¯­æ³•æ­£ç¡®æ€§
- è¿›è¡Œè¯­ä¹‰åˆ†æ
- ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
- æ‰§è¡Œ SQL è¯­å¥

```go
/*
SELECT id, name FROM users WHERE age > 18;

äº¤ç»™è¯­æ³•åˆ†æå™¨parserè§£æåçš„ASTç»“æ„ä¸ºï¼š

SelectStatement
â”œâ”€â”€ Fields
â”‚   â”œâ”€â”€ Identifier{Value: "id"}
â”‚   â””â”€â”€ Identifier{Value: "name"}
â”œâ”€â”€ TableName: "users"
â””â”€â”€ Where
    â””â”€â”€ BinaryExpression
        â”œâ”€â”€ Left: Identifier{Value: "age"}
        â”œâ”€â”€ Operator: ">"
        â””â”€â”€ Right: IntegerLiteral{Value: "18"}
 */

```

## 3. è¯­æ³•åˆ†æå™¨ (Parser)
> è¯­æ³•åˆ†æå™¨è´Ÿè´£å°†è¯æ³•åˆ†æå™¨ç”Ÿæˆçš„æ ‡è®°åºåˆ—è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ã€‚

SQL è§£æå™¨ï¼ˆParserï¼‰çš„å®ç°ï¼Œè´Ÿè´£å°†è¯æ³•åˆ†æå™¨ï¼ˆLexerï¼‰äº§ç”Ÿçš„æ ‡è®°ï¼ˆTokenï¼‰åºåˆ—è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚
è¯­æ³•åˆ†æå™¨SQL æ•°æ®åº“ç³»ç»Ÿçš„å…³é”®ç»„ä»¶ï¼Œè´Ÿè´£ï¼š
- éªŒè¯ SQL è¯­å¥çš„è¯­æ³•æ­£ç¡®æ€§
- æ„å»ºæŠ½è±¡è¯­æ³•æ ‘
- ä¸ºåç»­çš„è¯­ä¹‰åˆ†æå’Œæ‰§è¡Œæä¾›åŸºç¡€
  æ–°å»ºinternal/parser/parser.goã€‚

```sql
CREATE TABLE users (
id INT PRIMARY KEY,
name TEXT
);


è§£æè¿‡ç¨‹ï¼š
1. è¯†åˆ« CREATE å…³é”®å­—
2. è§£æ TABLE å…³é”®å­—
3. è§£æè¡¨å "users"
4. è§£æåˆ—å®šä¹‰ï¼š
åˆ—å "id"ï¼Œç±»å‹ INTï¼Œä¸»é”®
åˆ—å "name"ï¼Œç±»å‹ TEXT
5. ç”Ÿæˆ CREATE TABLE è¯­å¥çš„ AST
```

## 4. å­˜å‚¨å¼•æ“ (Storage)

> å­˜å‚¨å¼•æ“è´Ÿè´£å®é™…çš„æ•°æ®å­˜å‚¨å’Œæ£€ç´¢æ“ä½œã€‚

è¿™æ˜¯å†…å­˜å­˜å‚¨å¼•æ“çš„å®ç°ï¼Œè´Ÿè´£å¤„ç† SQL è¯­å¥çš„å®é™…æ‰§è¡Œå’Œæ•°æ®å­˜å‚¨ã€‚
æœ¬æœŸå­˜å‚¨å¼•æ“å®ç°äº†ï¼š
1. å®Œæ•´çš„æ•°æ®æ“ä½œï¼ˆCRUDï¼‰
2. ä¸»é”®çº¦æŸ
3. ç´¢å¼•æ”¯æŒ
4. ç±»å‹æ£€æŸ¥
5. æ¡ä»¶è¯„ä¼°
6. æ¨¡å¼åŒ¹é…
   å®ƒæ˜¯ SQL æ•°æ®åº“ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ï¼š
- æ•°æ®å­˜å‚¨å’Œç®¡ç†
- æŸ¥è¯¢æ‰§è¡Œ
- æ•°æ®å®Œæ•´æ€§ç»´æŠ¤
- æ€§èƒ½ä¼˜åŒ–ï¼ˆé€šè¿‡ç´¢å¼•ï¼‰

```sql
-- åˆ›å»ºè¡¨
CREATE TABLE users (
    id INT PRIMARY KEY,
    name TEXT
);

-- æ’å…¥æ•°æ®
INSERT INTO users VALUES (1, 'Alice');

-- æŸ¥è¯¢æ•°æ®
SELECT * FROM users WHERE name LIKE 'A%';

-- æ›´æ–°æ•°æ®
UPDATE users SET name = 'Bob' WHERE id = 1;

-- åˆ é™¤æ•°æ®
DELETE FROM users WHERE id = 1;


-- å­˜å‚¨å¼•æ“ä¼šæ ¹æ®è§£æåçš„è¯­æ³•åˆ†æå™¨ï¼Œåˆ›å»ºå‡ºå¯¹åº”çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ï¼šåœ¨å†…å­˜ä¸­ï¼‰ï¼Œä»¥åŠå¯¹å¤–æš´éœ²å¯¹è¯¥æ•°æ®çš„æ“ä½œï¼ˆCRUDï¼‰
```

## 5. REPL äº¤äº’ç•Œé¢

æœ€åï¼Œå®ç°ä¸€ä¸ªäº¤äº’å¼çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥è¾“å…¥ SQL å‘½ä»¤å¹¶æŸ¥çœ‹ç»“æœã€‚
è¿™æ˜¯ ZiyiDB çš„ä¸»ç¨‹åºï¼Œå®ç°äº†ä¸€ä¸ªäº¤äº’å¼çš„ SQL å‘½ä»¤è¡Œç•Œé¢ã€‚
> ä¸ºäº†å®ç°å®¢æˆ·ç«¯å¯ä»¥ä¸Šä¸‹ç¿»æ‰¾ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤ä»¥åŠcliå®¢æˆ·ç«¯çš„ç¾è§‚ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨"github.com/c-bata/go-prompt"åº“

ä¸»è¦å®ç°ï¼š
1. äº¤äº’å¼å‘½ä»¤è¡Œç•Œé¢
2. SQL å‘½ä»¤è§£æå’Œæ‰§è¡Œ
3. å‘½ä»¤å†å²è®°å½•
4. æŸ¥è¯¢ç»“æœæ ¼å¼åŒ–
5. é”™è¯¯å¤„ç†å’Œæç¤º


## ä½¿ç”¨ç¤ºä¾‹
```sql
-- 1. åˆ›å»ºè¡¨
CREATE TABLE users (id INT PRIMARY KEY,name TEXT,age INT);


-- 2. æ’å…¥ç”¨æˆ·æ•°æ®
INSERT INTO users VALUES (1, 'Alice', 20);
INSERT INTO users VALUES (2, 'Bob', 25);
INSERT INTO users VALUES (3, 'Charlie', 30);
INSERT INTO users VALUES (4, 'David', 35);
INSERT INTO users VALUES (5, 'Eve', 40);

-- 3. æµ‹è¯•ä¸»é”®å†²çª
INSERT INTO users VALUES (1, 'Tomas', 21);


-- 4. åŸºæœ¬æŸ¥è¯¢æµ‹è¯•
-- 4.1 æŸ¥è¯¢æ‰€æœ‰æ•°æ®
SELECT * FROM users;


-- 4.2 æŸ¥è¯¢ç‰¹å®šåˆ—
SELECT id, name FROM users;

-- 5. WHERE å­å¥æµ‹è¯•
-- æ¯”è¾ƒè¿ç®—ç¬¦ -- å¾…å®ç° != = >= <=é€»è¾‘
SELECT * FROM users WHERE age > 25;
SELECT * FROM users WHERE age < 30;

-- 6. LIKE æ“ä½œç¬¦æµ‹è¯•
insert into users values (6,'Alan',18);
SELECT * FROM users WHERE name LIKE 'A%';  -- ä»¥ A å¼€å¤´


-- 7. æ›´æ–°æ“ä½œæµ‹è¯•
-- 7.1 æ›´æ–°å•ä¸ªå­—æ®µ
UPDATE users SET age = 21 WHERE name = 'Alice';

-- 7.2 æ›´æ–°å¤šä¸ªå­—æ®µ
UPDATE users SET name = 'Robert', age = 8 WHERE id = 2;


-- 8. åˆ é™¤æ“ä½œæµ‹è¯•
DELETE FROM users WHERE age > 30;

-- 9. æ¸…ç†æµ‹è¯•æ•°æ®
DROP TABLE users;

-- 10. éªŒè¯è¡¨å·²åˆ é™¤
SELECT * FROM users;    -- åº”è¯¥å¤±è´¥

```

## å¦‚ä½•è¿è¡Œ

1. å…‹éš†ä»“åº“ï¼š
```bash
git clone https://github.com/ziyifast/ZiyiDB.git
cd ziyi-db
```

2. å®‰è£…ä¾èµ–ï¼š
```bash
go mod tidy
```

3. ç¼–è¯‘å¹¶è¿è¡Œï¼š
```bash
go build -o ZiyiDB cmd/main.go
./ZiyiDB
```

è¿è¡Œæ•ˆæœï¼š
<img width="652" alt="image" src="https://github.com/user-attachments/assets/06ff023d-e536-45ab-9451-2ff74588abb8" />




## è´¡çŒ®

ğŸš€æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼ä¹Ÿæ¬¢è¿å¤§å®¶starâ­ï¸ï¼ï¼ï¼

## è®¸å¯è¯

MIT License

## åç»­è§„åˆ’
todo::
1. å®ç°!= >= <=ç­‰è¿ç®—ç¬¦
2. æ”¯æŒæ›´å¤šæ•°æ®ç±»å‹
3. å®ç°å†…ç½®å‡½æ•°
4. ä¼˜åŒ–æŸ¥è¯¢ç»“æœå±•ç¤º
5. æ”¯æŒäº‹åŠ¡
...
...
